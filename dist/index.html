<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SPINNUP</title>

	<style type="text/css">
		body {
			margin: 0;
			padding: 0;
			height: 100%;
			background-color: #222;
		}
		.controls-wrapper {
			position: absolute;
			bottom: 5%;
			width: 100%;
			text-align: center;
		}
		.controls {
			transform: scale(1.0, 1.0);
			transition: all .2s;
		}
		@media only screen and (max-width: 760px), screen and (max-height: 420px) {
			.controls {
				transform: scale(0.7, 0.7);
			}
		}
		.controls.disabled {
			opacity: 0.5;
			pointer-events: none;
		}
		.controls .bt {
			width: 90px;
			height: 58px;
			display: inline-block;
			text-indent: 1000px;
			overflow: hidden;
			background-image: url("images/controls.png");
			opacity: 0.5;
		}
		.controls .bt:hover {
			opacity: 1.0;
		}
		.controls .prev {
			background-position: 0px 0px;
		}
		.controls .play {
			background-position: -180px 0px;
		}
		.controls .paused {
			background-position: -90px 0px;
		}
		.controls .next {
			background-position: -270px 0px;
		}
		#viz {
			position: fixed;
			height: 100%;
		}
	</style>
</head>
<body>
	<iframe id="viz" src="./viz.html" frameBorder="0" seamless width="100%" height="100%"></iframe>
	<div class="controls-wrapper">
		<nav class="controls disabled">
			<a href="" class="bt prev">prev</a>
			<a href="" class="bt play paused">play</a>
			<a href="" class="bt next">next</a>
		</nav>
	</div>

	<script type="text/javascript">
		var app = null;
		var currIndex = 0;
		var paused = true;
		var tracks = {
			Viz02: 'audio/MADANII-WVTCHMEN.mp3',
			Viz06: 'audio/INDIGO-PALACE-FIVERS.mp3',
			Viz07: 'audio/Chuchoter-Pieces.mp3',
			Viz10: 'audio/Maes-MaesEstLiberable-PART-II.mp3',
			Viz11: 'audio/Kiiara-Gold-feat-Lil-Wayne-Remix.mp3',
		}

		function getParam(name) {
			name = name.replace(/[\[]/, '\\\[').replace(/[\]]/, '\\\]');
			const regexS = '[\\?&]' + name + '=([^&#]*)';
			const regex = new RegExp(regexS);
			const results = regex.exec(window.location.search);
			if (!results) return '';
			return decodeURIComponent(results[1].replace(/\+/g, ' '));
		}

		function goto(index) {
			currIndex = index;

			var id = Object.keys(tracks)[currIndex];
			app.changeViz({ trackSrc: tracks[id], vizId: id, });

			document.querySelector('.controls').classList.add('disabled');
			updatePlayButton();
		}

		function prev() {
			if (currIndex > 0) goto(currIndex - 1);
			else goto(Object.keys(tracks).length - 1);
		}

		function next() {
			if (currIndex < Object.keys(tracks).length - 1) goto(currIndex + 1);
			else goto(0);
		}

		function updatePlayButton() {
			if (!app) return;

			var target = document.querySelector('.bt.play');
			if (app.isPaused) target.classList.add('paused');
			else target.classList.remove('paused');
		}

		function onPrevClick(e) {
			e.preventDefault();
			prev();
		}

		function onNextClick(e) {
			e.preventDefault();
			next();
		}

		function onPlayPauseClick(e) {
			e.preventDefault();

			if (!app) return;
			app[app.isPaused ? 'play' : 'pause']();
			updatePlayButton();
		}

		function onVizReady() {
			app = document.querySelector('#viz').contentWindow.app;
			var keys = Object.keys(tracks);
			var index = ~~(Math.random() * keys.length);
			var qindex = keys.indexOf(getParam('id'));
			if (qindex > -1) index = qindex;
			
			goto(index);
		}

		function onFilesLoaded() {
			document.querySelector('.controls').classList.remove('disabled');
		}

		function onAudioPlayPause(e) {
			updatePlayButton();
		}

		document.querySelector('.bt.prev').addEventListener('click', onPrevClick);
		document.querySelector('.bt.next').addEventListener('click', onNextClick);
		document.querySelector('.bt.play').addEventListener('click', onPlayPauseClick);
	</script>
</body>
</html>